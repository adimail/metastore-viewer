{% extends "base.html" %}
{% block title %}Query Editor{% endblock %}
{% block content %}
    <!-- Monaco Editor CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs/loader.min.js"></script>
    <div>
        <!-- Title -->
        <h1 class="text-3xl font-bold text-gray-800 mb-6">Query Editor</h1>
        <!-- Main Container -->
        <div class="flex space-x-4 h-screen">
            <!-- Query Editor Section (Left) -->
            <div class="flex-1 flex flex-col">
                <!-- Tabs Container -->
                <div id="tabs" class="flex space-x-2 mb-2">
                    <button onclick="addTab()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded">
                        <i class="fas fa-plus"></i> New Tab
                    </button>
                </div>
                <!-- Editor Container -->
                <div id="editor-container"
                     class="border rounded-lg shadow-lg"
                     style="height: 300px"></div>
                <!-- Action Buttons -->
                <div class="flex space-x-4 mt-4">
                    <button onclick="runQuery()"
                            class="bg-green-600 hover:bg-green-700 text-white font-semibold px-4 py-2 rounded transition">
                        <i class="fas fa-play"></i> Run Manual Query
                    </button>
                    <button onclick="saveQuery()"
                            class="bg-blue-600 hover:bg-blue-700 text-white font-semibold px-4 py-2 rounded transition">
                        <i class="fas fa-save"></i> Save
                    </button>
                    <button onclick="exportResults()"
                            class="bg-gray-600 hover:bg-gray-700 text-white font-semibold px-4 py-2 rounded transition">
                        <i class="fas fa-file-export"></i> Export
                    </button>
                </div>
                <!-- Natural Language Query Section -->
                <div class="mt-4">
                    <h2 class="text-xl font-semibold text-gray-700">Natural Language Query</h2>
                    <input type="text" id="nl-query-input" placeholder="Enter your natural language query" class="w-full p-2 border rounded">
                    <button onclick="runNLQuery()" class="bg-purple-600 hover:bg-purple-700 text-white font-semibold px-4 py-2 rounded mt-2">
                        Convert & Run
                    </button>
                </div>
                <!-- Query Results -->
                <div class="bg-white shadow-lg p-4 mt-6 rounded max-h-40 overflow-auto">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Query Results</h2>
                    <table class="min-w-full border border-gray-200" id="results-table">
                        <thead class="bg-gray-100">
                            <tr>
                                <th class="px-4 py-2 border text-left">ID</th>
                                <th class="px-4 py-2 border text-left">Name</th>
                                <th class="px-4 py-2 border text-left">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Results will be populated here -->
                        </tbody>
                    </table>
                </div>
                <!-- Query History -->
                <div class="bg-white shadow-lg p-4 mt-6 rounded max-h-40 overflow-auto">
                    <h2 class="text-xl font-semibold text-gray-700 mb-2">Query History</h2>
                    <ul class="space-y-2" id="query-history">
                        <li class="p-2 bg-gray-100 rounded">
                            SELECT * FROM sales_data LIMIT 10;
                            <span class="text-sm text-gray-500">- 10:00 AM</span>
                        </li>
                        <li class="p-2 bg-gray-100 rounded">
                            SELECT name, amount FROM sales_data;
                            <span class="text-sm text-gray-500">- 9:45 AM</span>
                        </li>
                    </ul>
                </div>
            </div>
            <!-- Schema Explorer (Right) -->
            <div class="w-1/4 bg-gray-100 p-4 rounded shadow flex flex-col h-full">
                <h2 class="text-xl font-semibold text-gray-700 mb-2">
                    <i class="fas fa-database"></i> Schema Explorer
                </h2>
                <!-- Search Bar -->
                <input type="text"
                       id="schema-search"
                       placeholder="Search schemas..."
                       class="w-full p-2 mb-2 border rounded" />
                <!-- Schema Tree -->
                <div id="schema-tree" class="border p-2 flex-1 overflow-y-auto">
                    <ul class="space-y-1">
                        <li>
                            <button class="toggle-btn font-semibold text-gray-700">
                                <i class="fas fa-chevron-down"></i> democatalog
                            </button>
                            <ul class="ml-4 space-y-1">
                                <li>
                                    <button class="toggle-btn font-medium">
                                        <i class="fas fa-chevron-down"></i> sales_data
                                    </button>
                                    <ul class="ml-6 hidden">
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> sale_id (INT)
                                        </li>
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> customer_name (VARCHAR)
                                        </li>
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> sale_amount (DECIMAL)
                                        </li>
                                    </ul>
                                </li>
                                <li>
                                    <button class="toggle-btn font-medium">
                                        <i class="fas fa-chevron-down"></i> orders
                                    </button>
                                    <ul class="ml-6 hidden">
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> order_id (BIGINT)
                                        </li>
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> order_date (DATE)
                                        </li>
                                        <li class="pl-4">
                                            <i class="fas fa-columns"></i> total_amount (DECIMAL)
                                        </li>
                                    </ul>
                                </li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
    <!-- JavaScript -->
    <script>
  // Toggle schema explorer nodes
  document.querySelectorAll(".toggle-btn").forEach((btn) => {
    btn.addEventListener("click", function () {
      const icon = this.querySelector("i");
      const sibling = this.nextElementSibling;
      if (sibling) {
        sibling.classList.toggle("hidden");
        icon.classList.toggle("fa-chevron-down");
        icon.classList.toggle("fa-chevron-right");
      }
    });
  });

  // Filter schema explorer items
  const searchInput = document.getElementById("schema-search");
  searchInput.addEventListener("input", function () {
    const filter = searchInput.value.toLowerCase();
    document.querySelectorAll("#schema-tree li").forEach((item) => {
      item.style.display = item.textContent.toLowerCase().includes(filter)
        ? ""
        : "none";
    });
  });

  // Initialize Monaco Editor
  let editor;
  require.config({
    paths: {
      vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.34.1/min/vs",
    },
  });
  require(["vs/editor/editor.main"], function () {
    editor = monaco.editor.create(
      document.getElementById("editor-container"),
      {
        value: `SELECT company_name,
       COUNT(job_id) AS total_postings,
       ROUND(AVG(salary), 2) AS avg_salary
FROM job_listings
WHERE post_date >= DATE_SUB(CURDATE(), INTERVAL 1 YEAR)
GROUP BY company_name
HAVING COUNT(job_id) > 5
ORDER BY total_postings DESC
LIMIT 10;`,
        language: "sql",
        theme: "vs-light",
        fontSize: 16,
        automaticLayout: true,
        lineNumbers: "on",
        scrollBeyondLastLine: false,
        minimap: { enabled: false },
      }
    );
  });

  // Run manual SQL query by calling the backend
  function runQuery() {
    const query = editor.getValue();
    fetch('/run-manual-query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ query: query })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        const tbody = document.querySelector("#results-table tbody");
        tbody.innerHTML = "";
        if(data.result && data.result.length > 0) {
            data.result.forEach(row => {
                const tr = document.createElement("tr");
                for (let key in row) {
                    const td = document.createElement("td");
                    td.className = "px-4 py-2 border";
                    td.textContent = row[key];
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
        } else {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.className = "px-4 py-2 border text-center";
            td.textContent = data.error ? data.error : "No results";
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    })
    .catch(err => {
        alert("Error: " + err);
    });
  }

  // Run natural language query: convert prompt to SQL and run it
  function runNLQuery() {
    const prompt = document.getElementById("nl-query-input").value;
    fetch('/run-nl-query', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ prompt: prompt })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data);
        const tbody = document.querySelector("#results-table tbody");
        tbody.innerHTML = "";
        if(data.result && data.result.length > 0) {
            data.result.forEach(row => {
                const tr = document.createElement("tr");
                for (let key in row) {
                    const td = document.createElement("td");
                    td.className = "px-4 py-2 border";
                    td.textContent = row[key];
                    tr.appendChild(td);
                }
                tbody.appendChild(tr);
            });
            alert("Converted SQL: " + data.sql);
        } else {
            const tr = document.createElement("tr");
            const td = document.createElement("td");
            td.colSpan = 3;
            td.className = "px-4 py-2 border text-center";
            td.textContent = data.error ? data.error : "No results";
            tr.appendChild(td);
            tbody.appendChild(tr);
        }
    })
    .catch(err => {
        alert("Error: " + err);
    });
  }

  function saveQuery() {
      // Placeholder for saving query
      alert("Save query functionality not implemented yet.");
  }

  function exportResults() {
      // Placeholder for exporting results
      alert("Export results functionality not implemented yet.");
  }
    </script>
{% endblock %}
